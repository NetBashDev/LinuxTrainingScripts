#!/bin/bash

# Comprobar si se ejecuta como root
if [ "$(id -u)" -ne 0 ]; then
    echo "Este script debe ejecutarse como root o con sudo."
    exit 1
fi

# Pedir al usuario el nombre del nuevo usuario
read -p "Ingrese el nombre del nuevo usuario: " USUARIO

# Verificar si el usuario ya existe
if id "$USUARIO" &>/dev/null; then
    echo "El usuario '$USUARIO' ya existe. Saliendo..."
    exit 1
fi

# Pedir información adicional
read -p "Ingrese el shell predeterminado (por defecto: /bin/bash): " SHELL
SHELL=${SHELL:-/bin/bash}

read -p "Ingrese el nombre del grupo primario (por defecto: users): " GRUPO
GRUPO=${GRUPO:-users}

# Crear el grupo si no existe
if ! grep -q "^$GRUPO:" /etc/group; then
    echo "El grupo '$GRUPO' no existe. Creándolo..."
    groupadd "$GRUPO"
fi

# Crear el usuario con su directorio home
useradd -m -s "$SHELL" -g "$GRUPO" "$USUARIO"

# Generar contraseña aleatoria
PASSWORD=$(openssl rand -base64 12)
echo "$USUARIO:$PASSWORD" | chpasswd

# Forzar cambio de contraseña al primer inicio
chage -d 0 "$USUARIO"

# Mostrar resumen
echo "Usuario '$USUARIO' creado exitosamente."
echo "  - Contraseña temporal: $PASSWORD"
echo "  - Shell: $SHELL"
echo "  - Grupo primario: $GRUPO"
echo "El usuario debe cambiar su contraseña al primer inicio de sesión."

